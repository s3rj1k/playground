# https://github.com/tinkerbell/playground/blob/main/capt/templates/kustomization-netboot.tmpl
# https://github.com/tinkerbell/playground/blob/main/capt/templates/kustomization-iso.tmpl

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: $NAMESPACE
resources:
  - prekustomization.yaml
patches:

  - target:
      group: infrastructure.cluster.x-k8s.io
      kind: TinkerbellMachineTemplate
      name: ".*control-plane.*"
      version: v1beta1
    patch: |-
      - op: add
        path: /spec/template/spec
        value:
          bootOptions:
            bootMode: netboot
          hardwareAffinity:
            required:
            - labelSelector:
                matchLabels:
                  tinkerbell.org/role: control-plane
          templateOverride: |
            version: "0.1"
            name: playground-template
            global_timeout: 9000
            tasks:
              - name: "playground-template"
                worker: "{{.device_1}}"
                volumes:
                  - /dev:/dev
                  - /dev/console:/dev/console
                  - /lib/firmware:/lib/firmware:ro
                actions:

                  - name: "Stream Ubuntu Image"
                    image: quay.io/tinkerbell/actions/image2disk:latest
                    timeout: 3000
                    environment:
                      DEST_DISK: {{ index .Hardware.Disks 0 }}
                      IMG_URL: $TINKERBELL_ARTIFACTS_SERVER/$IMAGE_FILENAME
                      COMPRESSED: true

                  - name: "Sync and Grow Partition"
                    image: quay.io/tinkerbell/actions/cexec:latest
                    timeout: 90
                    environment:
                      BLOCK_DEVICE: {{ index .Hardware.Disks 0 }}3
                      FS_TYPE: ext4
                      CHROOT: y
                      DEFAULT_INTERPRETER: "/bin/sh -c"
                      CMD_LINE: "sync && growpart {{ index .Hardware.Disks 0 }} 3 && resize2fs {{ index .Hardware.Disks 0 }}3 && sync"

                  - name: "Add Tink Cloud-Init Config"
                    image: quay.io/tinkerbell/actions/writefile:latest
                    timeout: 90
                    environment:
                      DEST_DISK: {{ formatPartition ( index .Hardware.Disks 0 ) 3 }}
                      FS_TYPE: ext4
                      DEST_PATH: /etc/cloud/cloud.cfg.d/10_tinkerbell.cfg
                      UID: 0
                      GID: 0
                      MODE: 0600
                      DIRMODE: 0700
                      CONTENTS: |
                        datasource:
                          Ec2:
                            metadata_urls: ["http://$TINKERBELL_IP:7172"]
                            strict_id: false
                        system_info:
                          default_user:
                            name: tink
                            groups: [wheel, adm]
                            sudo: ["ALL=(ALL) NOPASSWD:ALL"]
                            shell: /bin/bash
                        manage_etc_hosts: localhost
                        warnings:
                          dsid_missing_source: off

                  - name: "Add Tink Cloud-Init DS-Identity"
                    image: quay.io/tinkerbell/actions/writefile:latest
                    timeout: 90
                    environment:
                      DEST_DISK: {{ formatPartition ( index .Hardware.Disks 0 ) 3 }}
                      FS_TYPE: ext4
                      DEST_PATH: /etc/cloud/ds-identify.cfg
                      UID: 0
                      GID: 0
                      MODE: 0600
                      DIRMODE: 0700
                      CONTENTS: |
                        datasource: Ec2

                  - name: "Reboot into installed OS"
                    image: ghcr.io/jacobweinstock/waitdaemon:latest
                    timeout: 90
                    pid: host
                    command: ["reboot"]
                    environment:
                      IMAGE: alpine
                      WAIT_SECONDS: 10
                    volumes:
                      - /var/run/docker.sock:/var/run/docker.sock

  - target:
      group: infrastructure.cluster.x-k8s.io
      kind: TinkerbellMachineTemplate
      name: ".*worker.*"
      version: v1beta1
    patch: |-
      - op: add
        path: /spec/template/spec
        value:
          bootOptions:
            bootMode: isoboot
            isoURL: "http://$TINKERBELL_IP:7171/iso/hook.iso"
          hardwareAffinity:
            required:
            - labelSelector:
                matchLabels:
                  tinkerbell.org/role: worker
          templateOverride: |
            version: "0.1"
            name: playground-template
            global_timeout: 9000
            tasks:
              - name: "playground-template"
                worker: "{{.device_1}}"
                volumes:
                  - /dev:/dev
                  - /dev/console:/dev/console
                  - /lib/firmware:/lib/firmware:ro
                actions:

                  - name: "Stream Ubuntu Image"
                    image: quay.io/tinkerbell/actions/image2disk:latest
                    timeout: 3000
                    environment:
                      DEST_DISK: {{ index .Hardware.Disks 0 }}
                      IMG_URL: $TINKERBELL_ARTIFACTS_SERVER/$IMAGE_FILENAME
                      COMPRESSED: true

                  - name: "Sync and Grow Partition"
                    image: quay.io/tinkerbell/actions/cexec:latest
                    timeout: 90
                    environment:
                      BLOCK_DEVICE: {{ index .Hardware.Disks 0 }}3
                      FS_TYPE: ext4
                      CHROOT: y
                      DEFAULT_INTERPRETER: "/bin/sh -c"
                      CMD_LINE: "sync && growpart {{ index .Hardware.Disks 0 }} 3 && resize2fs {{ index .Hardware.Disks 0 }}3 && sync"

                  - name: "Add Tink Cloud-Init Config"
                    image: quay.io/tinkerbell/actions/writefile:latest
                    timeout: 90
                    environment:
                      DEST_DISK: {{ formatPartition ( index .Hardware.Disks 0 ) 3 }}
                      FS_TYPE: ext4
                      DEST_PATH: /etc/cloud/cloud.cfg.d/10_tinkerbell.cfg
                      UID: 0
                      GID: 0
                      MODE: 0600
                      DIRMODE: 0700
                      CONTENTS: |
                        datasource:
                          Ec2:
                            metadata_urls: ["http://$TINKERBELL_IP:7172"]
                            strict_id: false
                        system_info:
                          default_user:
                            name: tink
                            groups: [wheel, adm]
                            sudo: ["ALL=(ALL) NOPASSWD:ALL"]
                            shell: /bin/bash
                        manage_etc_hosts: localhost
                        warnings:
                          dsid_missing_source: off

                  - name: "Disable Cloud-Init networking"
                    image: quay.io/tinkerbell/actions/writefile:latest
                    timeout: 90
                    environment:
                      CONTENTS: 'network: {config: disabled}'
                      DEST_DISK: '{{ formatPartition ( index .Hardware.Disks 0 ) 3 }}'
                      DEST_PATH: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
                      DIRMODE: "0700"
                      FS_TYPE: ext4
                      GID: "0"
                      MODE: "0600"
                      UID: "0"

                  - name: "Write static Netplan"
                    image: quay.io/tinkerbell/actions/writefile:latest
                    timeout: 90
                    environment:
                      CONTENTS: |
                        network:
                          version: 2
                          renderer: networkd
                          ethernets:
                            id0:
                              match:
                                macaddress: {{ (index .Hardware.Interfaces 0).DHCP.MAC }}
                              addresses:
                                - {{ (index .Hardware.Interfaces 0).DHCP.IP.Address }}/16
                              nameservers:
                                addresses: [{{ (index .Hardware.Interfaces 0).DHCP.NameServers | join ","}}]
                              routes:
                                - to: default
                                  via: {{ (index .Hardware.Interfaces 0).DHCP.IP.Gateway }}
                      DEST_DISK: '{{ formatPartition ( index .Hardware.Disks 0 ) 3 }}'
                      DEST_PATH: /etc/netplan/config.yaml
                      DIRMODE: "0755"
                      FS_TYPE: ext4
                      GID: "0"
                      MODE: "0600"
                      UID: "0"

                  - name: "Add Tink Cloud-Init DS-Identity"
                    image: quay.io/tinkerbell/actions/writefile:latest
                    timeout: 90
                    environment:
                      DEST_DISK: {{ formatPartition ( index .Hardware.Disks 0 ) 3 }}
                      FS_TYPE: ext4
                      DEST_PATH: /etc/cloud/ds-identify.cfg
                      UID: 0
                      GID: 0
                      MODE: 0600
                      DIRMODE: 0700
                      CONTENTS: |
                        datasource: Ec2

                  - name: "Kexec into installed OS"
                    image: ghcr.io/jacobweinstock/waitdaemon:latest
                    timeout: 90
                    pid: host
                    environment:
                      BLOCK_DEVICE: {{ index .Hardware.Disks 0 }}1
                      FS_TYPE: vfat
                      GRUBCFG_PATH: grub/grub.cfg
                      IMAGE: quay.io/tinkerbell/actions/kexec
                      WAIT_SECONDS: 5
                    volumes:
                      - /var/run/docker.sock:/var/run/docker.sock

  - target:
      group: bootstrap.cluster.x-k8s.io
      kind: KubeadmConfigTemplate
      name: "$CLUSTER_NAME-.*"
      version: v1beta1
    patch: |-
      - op: add
        path: /spec/template/spec/users
        value:
          - name: tink
            passwd: $2a$10$1eIf7v/k.Njafoq3ND3PteLDYiOyRfQuVr8Zd67aFIuvJt/BRt8Tq
            sudo: ALL=(ALL) NOPASSWD:ALL
            sshAuthorizedKeys:
              - $SSH_AUTH_KEY

  - target:
      group: controlplane.cluster.x-k8s.io
      kind: KubeadmControlPlane
      name: "$CLUSTER_NAME-.*"
      version: v1beta1
    patch: |-
      - op: add
        path: /spec/kubeadmConfigSpec/users
        value:
          - name: tink
            passwd: $2a$10$1eIf7v/k.Njafoq3ND3PteLDYiOyRfQuVr8Zd67aFIuvJt/BRt8Tq
            sudo: ALL=(ALL) NOPASSWD:ALL
            sshAuthorizedKeys:
              - $SSH_AUTH_KEY

  - target:
      group: controlplane.cluster.x-k8s.io
      kind: KubeadmControlPlane
      name: "$CLUSTER_NAME-.*"
      version: v1beta1
    patch: |-
      - op: add
        path: /spec/kubeadmConfigSpec/preKubeadmCommands
        value:
          # Deploy kube-vip as a static pod
          - |
            mkdir -p /etc/kubernetes/manifests
            ctr images pull ghcr.io/kube-vip/kube-vip:v$KUBEVIP_VERSION

            DEFAULT_INTERFACE=$(ip -4 -j route list default | jq -r .[0].dev)

            ctr run --rm --net-host \
              ghcr.io/kube-vip/kube-vip:v$KUBEVIP_VERSION vip \
              /kube-vip manifest pod \
              --arp \
              --interface "$DEFAULT_INTERFACE" \
              --address "$CONTROL_PLANE_VIP" \
              --controlplane \
              --leaderElection \
              --k8sConfigPath /etc/kubernetes/super-admin.conf \
              > /etc/kubernetes/manifests/kube-vip.yaml
