# Copyright 2025 s3rj1k
# SPDX-License-Identifier: MIT

# Entrypoint playbook to configure a complete lab environment
# DEBUG: ansible-pull -U https://github.com/s3rj1k/playground.git playbooks/lab.yml
#        ansible-pull -U https://github.com/s3rj1k/playground.git -e "REGISTRY_MIRROR=https://registry.example.com:5000" playbooks/lab.yml
#        ansible-pull -U https://github.com/s3rj1k/playground.git -e "INSTALL_LIBVIRT=false" playbooks/lab.yml
#        ansible-pull -U https://github.com/s3rj1k/playground.git -e "INSTALL_ZOT=false" playbooks/lab.yml
#        ansible-pull -U https://github.com/s3rj1k/playground.git -e "INSTALL_CERT_MANAGER=false" playbooks/lab.yml
#        ansible-pull -U https://github.com/s3rj1k/playground.git -e "INSTALL_FLUX_CD=false" -e "INSTALL_KRO=false" playbooks/lab.yml
#        ansible-pull -U https://github.com/s3rj1k/playground.git -e "KITE_HOSTNAMES=['kite.local','kite.example.com']" playbooks/lab.yml

---
- name: Set global variables
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    REGISTRY_MIRROR: ""
    INSTALL_LIBVIRT: true
    SUSHY_HACKS: true
    INSTALL_ZOT: false
    ZOT_LISTEN_ADDRESS: "0.0.0.0"
    ZOT_PORT: "4269"
    ZOT_TLS_ENABLED: true
    # k8s-deb flags
    CLUSTER_CIDR: "172.20.0.0/16"
    SERVICE_CIDR: "172.21.0.0/16"
    LB_IP_RANGE_START: ""
    LB_IP_RANGE_STOP: ""
    # k8s-addons flags
    INSTALL_CERT_MANAGER: true
    INSTALL_FLUX_CD: true
    INSTALL_CLUSTER_API_OPERATOR: true
    INSTALL_KRO: true
    INSTALL_KITE: false
    INSTALL_TRAEFIK: true
    TRAEFIK_HCP_MODE: false
    CILIUM_LB_ENABLED: true
    INSTALL_OPENEBS: true
    INSTALL_LOCAL_PATH_PROVISIONER: false
    KITE_HOSTNAMES:
      - "kite.local"
    KITE_TLS_PORT: 4271
    KITE_NODEPORT: 30271
  tasks:
    - name: Set global facts
      set_fact:
        REGISTRY_MIRROR: "{{ REGISTRY_MIRROR }}"
        INSTALL_LIBVIRT: "{{ INSTALL_LIBVIRT }}"
        SUSHY_HACKS: "{{ SUSHY_HACKS }}"
        INSTALL_ZOT: "{{ INSTALL_ZOT }}"
        ZOT_LISTEN_ADDRESS: "{{ ZOT_LISTEN_ADDRESS }}"
        ZOT_PORT: "{{ ZOT_PORT }}"
        ZOT_TLS_ENABLED: "{{ ZOT_TLS_ENABLED }}"
        CLUSTER_CIDR: "{{ CLUSTER_CIDR }}"
        SERVICE_CIDR: "{{ SERVICE_CIDR }}"
        LB_IP_RANGE_START: "{{ LB_IP_RANGE_START }}"
        LB_IP_RANGE_STOP: "{{ LB_IP_RANGE_STOP }}"
        INSTALL_CERT_MANAGER: "{{ INSTALL_CERT_MANAGER }}"
        INSTALL_FLUX_CD: "{{ INSTALL_FLUX_CD }}"
        INSTALL_CLUSTER_API_OPERATOR: "{{ INSTALL_CLUSTER_API_OPERATOR }}"
        INSTALL_KRO: "{{ INSTALL_KRO }}"
        INSTALL_KITE: "{{ INSTALL_KITE }}"
        INSTALL_TRAEFIK: "{{ INSTALL_TRAEFIK }}"
        TRAEFIK_HCP_MODE: "{{ TRAEFIK_HCP_MODE }}"
        CILIUM_LB_ENABLED: "{{ CILIUM_LB_ENABLED }}"
        INSTALL_OPENEBS: "{{ INSTALL_OPENEBS }}"
        INSTALL_LOCAL_PATH_PROVISIONER: "{{ INSTALL_LOCAL_PATH_PROVISIONER }}"
        KITE_HOSTNAMES: "{{ KITE_HOSTNAMES }}"
        KITE_TLS_PORT: "{{ KITE_TLS_PORT }}"
        KITE_NODEPORT: "{{ KITE_NODEPORT }}"
        cacheable: yes

- name: Import base configuration playbook
  import_playbook: base.yml

- name: Import libvirt configuration playbook
  import_playbook: libvirt.yml
  when: INSTALL_LIBVIRT | bool

- name: Import tools installation playbook
  import_playbook: tools.yml

- name: Import zot registry playbook
  import_playbook: zot.yml
  when: INSTALL_ZOT | bool

- name: Import kubeadm Kubernetes playbook
  import_playbook: k8s-deb.yml

- name: Import Kubernetes addons playbook
  import_playbook: k8s-addons.yml

- name: Final system checks
  hosts: localhost
  connection: local
  become: true
  gather_facts: false
  tasks:
    - name: Check if system reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required_file

    - name: Display reboot requirement
      debug:
        msg: "System reboot is required to complete the lab setup"
      when: reboot_required_file.stat.exists
