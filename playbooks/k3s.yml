# Copyright 2025 s3rj1k
# SPDX-License-Identifier: MIT

# DEBUG: ansible-pull -U https://github.com/s3rj1k/playground.git playbooks/k3s.yml
#        ansible-pull -U https://github.com/s3rj1k/playground.git -e "K3S_TOKEN=mytoken" playbooks/k3s.yml
#        ansible-pull -U https://github.com/s3rj1k/playground.git -e "CLUSTER_CIDR=10.42.0.0/16" playbooks/k3s.yml
#        ansible-pull -U https://github.com/s3rj1k/playground.git -e "REGISTRY_MIRROR=https://registry.example.com:5000" playbooks/k3s.yml
#        ansible-pull -U https://github.com/s3rj1k/playground.git -e "KITE_HOSTNAMES=['kite.local','kite.example.com']" playbooks/k3s.yml
#        ansible-pull -U https://github.com/s3rj1k/playground.git -e "DISABLE_SERVICELB=true" playbooks/k3s.yml

---
- name: Kubernetes (k3s)
  hosts: localhost
  connection: local
  become: true
  gather_facts: true
  ignore_errors: false
  vars:
    K3S_TOKEN: ""
    CLUSTER_CIDR: "172.20.0.0/16"
    SERVICE_CIDR: "172.21.0.0/16"
    K3S_EXTRA_FLAGS: ""
    DISABLE_SERVICELB: false
    REGISTRY_MIRROR: ""
    INSTALL_CERT_MANAGER: true
    INSTALL_FLUX_CD: true
    INSTALL_CLUSTER_API_OPERATOR: true
    INSTALL_KRO: true
    INSTALL_K3K: true
    INSTALL_KITE: true
    KITE_HOSTNAMES:
      - "kite.local"
    KITE_TLS_PORT: 4271

  pre_tasks:
    - name: Wait for system to be ready
      wait_for:
        path: /var/lib/cloud/instance/boot-finished
        timeout: 600
      when: ansible_service_mgr is defined and lookup('env', 'CLOUD_INIT') != ''

  tasks:
    - name: Configure registry mirror
      block:
        - name: Create k3s config directory
          file:
            path: /etc/rancher/k3s
            state: directory
            mode: "0755"

        - name: Configure registry mirrors
          copy:
            dest: /etc/rancher/k3s/registries.yaml
            content: |
              mirrors:
                docker.io:
                  endpoint:
                    - "{{ REGISTRY_MIRROR }}"
                registry.k8s.io:
                  endpoint:
                    - "{{ REGISTRY_MIRROR }}"
                gcr.io:
                  endpoint:
                    - "{{ REGISTRY_MIRROR }}"
                ghcr.io:
                  endpoint:
                    - "{{ REGISTRY_MIRROR }}"
                quay.io:
                  endpoint:
                    - "{{ REGISTRY_MIRROR }}"
              configs:
                "{{ REGISTRY_MIRROR | regex_replace('^https?://(.*)$', '\\1') }}":
                  tls:
                    insecure_skip_verify: true
            mode: "0644"
      when: REGISTRY_MIRROR is defined and REGISTRY_MIRROR | trim | length > 0

    - name: Prepare Kubernetes component manifests for auto-deploy
      block:
        - name: Ensure k3s manifests directory exists
          file:
            path: /var/lib/rancher/k3s/server/manifests
            state: directory
            mode: "0755"

        - name: Download cert-manager manifest
          get_url:
            url: https://github.com/jetstack/cert-manager/releases/latest/download/cert-manager.yaml
            dest: /var/lib/rancher/k3s/server/manifests/cert-manager.yaml
            mode: "0644"
          when: INSTALL_CERT_MANAGER | bool

        - name: Create self-signed ClusterIssuer for cert-manager
          copy:
            dest: /var/lib/rancher/k3s/server/manifests/cert-manager-selfsigned-issuer.yaml
            content: |
              apiVersion: cert-manager.io/v1
              kind: ClusterIssuer
              metadata:
                name: selfsigned-issuer
              spec:
                selfSigned: {}
            mode: "0644"
          when: INSTALL_CERT_MANAGER | bool

        - name: Get latest Gateway API release version
          uri:
            url: https://api.github.com/repos/kubernetes-sigs/gateway-api/releases/latest
            return_content: yes
          register: gateway_api_release

        - name: Install experimental Gateway API TLSRoute CRD
          get_url:
            url: "https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/{{ gateway_api_release.json.tag_name }}/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml"
            dest: /var/lib/rancher/k3s/server/manifests/gateway-tlsroute-crd.yaml
            mode: "0644"

        - name: Install experimental Gateway API TCPRoute CRD
          get_url:
            url: "https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/{{ gateway_api_release.json.tag_name }}/config/crd/experimental/gateway.networking.k8s.io_tcproutes.yaml"
            dest: /var/lib/rancher/k3s/server/manifests/gateway-tcproute-crd.yaml
            mode: "0644"

        - name: Install experimental Gateway API BackendTLSPolicy CRD
          get_url:
            url: "https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/{{ gateway_api_release.json.tag_name }}/config/crd/experimental/gateway.networking.k8s.io_backendtlspolicies.yaml"
            dest: /var/lib/rancher/k3s/server/manifests/gateway-backendtlspolicy-crd.yaml
            mode: "0644"

        - name: Configure Traefik with Gateway API and custom entrypoints
          copy:
            dest: /var/lib/rancher/k3s/server/manifests/traefik-config.yaml
            content: |
              apiVersion: helm.cattle.io/v1
              kind: HelmChartConfig
              metadata:
                name: traefik
                namespace: kube-system
              spec:
                valuesContent: |
                  providers:
                    kubernetesGateway:
                      enabled: true
                      experimentalChannel: true
                  gateway:
                    enabled: true
                  ports:
                    web:
                      expose:
                        default: false
                    websecure:
                      expose:
                        default: false
              {% if DISABLE_SERVICELB | bool %}
                    hcp:
                      port: 8132
                      expose:
                        default: true
                      exposedPort: 8132
                      protocol: TCP
                    hcpgw:
                      port: 443
                      expose:
                        default: true
                      exposedPort: 443
                      protocol: TCP
                    hcplegacy:
                      port: 6443
                      expose:
                        default: true
                      exposedPort: 6443
                      protocol: TCP
              {% endif %}
              {% if INSTALL_KITE | bool %}
                    kite:
                      port: {{ KITE_TLS_PORT }}
                      expose:
                        default: true
                      exposedPort: {{ KITE_TLS_PORT }}
              {% if DISABLE_SERVICELB | bool %}
                      hostPort: {{ KITE_TLS_PORT }}
              {% endif %}
                      protocol: TCP
                      tls:
                        enabled: true
              {% endif %}
            mode: "0644"

        - name: Download Flux CD manifest
          get_url:
            url: https://github.com/fluxcd/flux2/releases/latest/download/install.yaml
            dest: /var/lib/rancher/k3s/server/manifests/flux-cd.yaml
            mode: "0644"
          when: INSTALL_FLUX_CD | bool

        - name: Download Cluster API Operator manifest
          get_url:
            url: https://github.com/kubernetes-sigs/cluster-api-operator/releases/latest/download/operator-components.yaml
            dest: /var/lib/rancher/k3s/server/manifests/cluster-api-operator.yaml
            mode: "0644"
          when: INSTALL_CLUSTER_API_OPERATOR | bool

        - name: Create kro HelmChart manifest for k3s auto-deploy
          copy:
            dest: /var/lib/rancher/k3s/server/manifests/kro-helmchart.yaml
            content: |
              apiVersion: helm.cattle.io/v1
              kind: HelmChart
              metadata:
                name: kro
                namespace: kube-system
              spec:
                chart: oci://registry.k8s.io/kro/charts/kro
                targetNamespace: kro-system
                createNamespace: true
                valuesContent: ""
            mode: "0644"
          when: INSTALL_KRO | bool

        - name: Create k3k HelmChart manifest for k3s auto-deploy
          copy:
            dest: /var/lib/rancher/k3s/server/manifests/k3k-helmchart.yaml
            content: |
              apiVersion: helm.cattle.io/v1
              kind: HelmChart
              metadata:
                name: k3k
                namespace: kube-system
              spec:
                chart: k3k
                repo: https://rancher.github.io/k3k
                targetNamespace: k3k-system
                createNamespace: true
                valuesContent: ""
            mode: "0644"
          when: INSTALL_K3K | bool

        - name: Generate kite admin password
          set_fact:
            kite_admin_password: "{{ lookup('password', '/dev/null length=16 chars=ascii_letters,digits') }}"
          when: INSTALL_KITE | bool

        - name: Create kite HelmChart manifest for k3s auto-deploy
          copy:
            dest: /var/lib/rancher/k3s/server/manifests/kite-helmchart.yaml
            content: |
              apiVersion: helm.cattle.io/v1
              kind: HelmChart
              metadata:
                name: kite
                namespace: kube-system
              spec:
                chart: kite
                repo: https://zxh326.github.io/kite
                targetNamespace: kite-system
                createNamespace: true
                valuesContent: |
                  service:
                    port: {{ KITE_TLS_PORT }}
                    targetPort: {{ KITE_TLS_PORT }}
                  extraEnvs:
                    - name: PORT
                      value: "{{ KITE_TLS_PORT }}"
                    - name: ENABLE_ANALYTICS
                      value: "false"
                  superUser:
                    create: true
                    username: "admin"
                    password: "{{ kite_admin_password }}"
                  ingress:
                    enabled: true
                    className: "traefik"
                    annotations:
                      cert-manager.io/cluster-issuer: "selfsigned-issuer"
                      traefik.ingress.kubernetes.io/router.entrypoints: "kite"
                      traefik.ingress.kubernetes.io/router.tls: "true"
                    hosts:
                      - paths:
                          - path: /
                            pathType: Prefix
              {% for hostname in KITE_HOSTNAMES %}
                      - host: "{{ hostname }}"
                        paths:
                          - path: /
                            pathType: Prefix
              {% endfor %}
                    tls:
                      - secretName: kite-tls
                        hosts:
              {% for hostname in KITE_HOSTNAMES %}
                          - "{{ hostname }}"
              {% endfor %}
            mode: "0644"
          when: INSTALL_KITE | bool

        - name: Save kite credentials to file
          copy:
            dest: /root/.kite-credentials
            content: |
              Kite Dashboard Credentials
              ==========================
              {% for hostname in KITE_HOSTNAMES %}
              URL:      https://{{ hostname }}:{{ KITE_TLS_PORT }}/
              {% endfor %}
              Username: admin
              Password: {{ kite_admin_password }}
            mode: "0600"
          when: INSTALL_KITE | bool

    - name: Install k3s
      block:
        - name: Download k3s installation script
          get_url:
            url: https://get.k3s.io
            dest: /tmp/k3s-install.sh
            mode: "0755"

        - name: Install k3s server with cluster-init
          shell: |
            /tmp/k3s-install.sh server --cluster-init \
              --cluster-cidr={{ CLUSTER_CIDR }} \
              --service-cidr={{ SERVICE_CIDR }} \
              {{ '--disable=servicelb' if DISABLE_SERVICELB | bool else '' }} \
              {{ K3S_EXTRA_FLAGS }}
          args:
            executable: /bin/bash
            creates: /usr/local/bin/k3s
          environment:
            K3S_TOKEN: "{{ K3S_TOKEN }}"
          when: K3S_TOKEN is defined and K3S_TOKEN | trim | length > 0

        - name: Install k3s server with cluster-init (no token)
          shell: |
            /tmp/k3s-install.sh server --cluster-init \
              --cluster-cidr={{ CLUSTER_CIDR }} \
              --service-cidr={{ SERVICE_CIDR }} \
              {{ '--disable=servicelb' if DISABLE_SERVICELB | bool else '' }} \
              {{ K3S_EXTRA_FLAGS }}
          args:
            executable: /bin/bash
            creates: /usr/local/bin/k3s
          when: K3S_TOKEN is not defined or K3S_TOKEN | trim | length == 0

        - name: Wait for k3s node to be ready
          shell: k3s kubectl wait --for=condition=Ready node --all --timeout=0s
          register: k3s_node_ready
          until: k3s_node_ready.rc == 0
          retries: 42
          delay: 30
          changed_when: false

        - name: Remove installation script
          file:
            path: /tmp/k3s-install.sh
            state: absent

    - name: Configure kubectl access
      block:
        - name: Create .kube directory
          file:
            path: /root/.kube
            state: directory
            mode: "0755"

        - name: Copy k3s kubeconfig to .kube/config
          copy:
            src: /etc/rancher/k3s/k3s.yaml
            dest: /root/.kube/config
            remote_src: true
            mode: "0600"

    - name: Install k3k CLI
      block:
        - name: Get latest k3k CLI version
          uri:
            url: "https://api.github.com/repos/rancher/k3k/releases/latest"
            return_content: yes
          register: k3k_release_info

        - name: Download and install k3k CLI
          get_url:
            url: "https://github.com/rancher/k3k/releases/download/{{ k3k_release_info.json.tag_name }}/k3kcli-linux-amd64"
            dest: /usr/local/bin/k3kcli
            mode: "0755"
          when: k3k_release_info is defined and k3k_release_info.status == 200
      when: INSTALL_K3K | bool
