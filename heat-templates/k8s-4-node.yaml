# Copyright 2025 s3rj1k
# SPDX-License-Identifier: MIT

heat_template_version: 2021-04-16

description: Template for 4 node K8s HA Cluster (3 CP + 1 Worker)

parameters:
  prefix:
    type: string
    description: "Resource name prefix"
    label: "Resource name prefix"
    constraints:
      - length:
          min: 1
          max: 32
        description: "Resource name prefix must be between 1 and 32 characters"
      - allowed_pattern: "^[a-zA-Z0-9-_]+$"
        description: "Resource name prefix can only contain letters, numbers, underscore and hyphen"

  registry_mirror:
    type: string
    description: "Image registry mirror URL"
    label: "Image Registry Mirror"

  image_id:
    type: string
    description: "Image to use for the instances."
    default: ubuntu-24.04-minimal-cloudimg-amd64
    label: "Server Image"
    constraints:
      - allowed_values:
          - ubuntu-24.04-minimal-cloudimg-amd64
        description: "Must be a known Image ID"

  ssh_pub_key:
    type: string
    description: "SSH public key for instance access"
    label: "SSH Public Key"
    constraints:
      - length:
          min: 1

  external_network:
    type: string
    description: "External network for router gateway"
    default: "public"
    label: "External Network"

  network_cidr:
    type: string
    description: "CIDR for the network"
    default: "10.42.71.0/24"
    label: "Network CIDR"

  allocation_pool_start:
    type: string
    description: "Start of IP allocation pool"
    default: "10.42.71.200"
    label: "Allocation Pool Start"

  allocation_pool_stop:
    type: string
    description: "End of IP allocation pool"
    default: "10.42.71.250"
    label: "Allocation Pool Stop"

  cp_lb_ip:
    type: string
    description: "Virtual IP for Control Plane LoadBalancer (Cilium L2)"
    default: "10.42.71.100"
    label: "Control Plane LB VIP"

  cp_1_ip:
    type: string
    description: "IP address for first control plane node"
    default: "10.42.71.101"
    label: "CP 1 IP"

  cp_2_ip:
    type: string
    description: "IP address for second control plane node"
    default: "10.42.71.102"
    label: "CP 2 IP"

  cp_3_ip:
    type: string
    description: "IP address for third control plane node"
    default: "10.42.71.103"
    label: "CP 3 IP"

  worker_1_ip:
    type: string
    description: "IP address for worker node"
    default: "10.42.71.111"
    label: "Worker 1 IP"

  availability_zone:
    type: string
    description: "Availability zone for instances"
    default: "nova"
    label: "Availability Zone"

  cp_flavor:
    type: string
    description: "Flavor for control plane instances"
    default: "system.golden.kubernetes.control"
    label: "Control Plane Instance Flavor"

  worker_flavor:
    type: string
    description: "Flavor for worker instances"
    default: "a1.large"
    label: "Worker Instance Flavor"

  cp_volume_size:
    type: number
    description: "Size of root volume for control plane nodes in GB"
    default: 100
    label: "Control Plane Volume Size"

  worker_volume_size:
    type: number
    description: "Size of root volume for worker nodes in GB"
    default: 80
    label: "Worker Volume Size"

  ansible_playbook:
    type: string
    description: "Ansible playbook to use"
    default: "playbooks/k8s-deb.yml"
    label: "Ansible playbook"
    constraints:
      - allowed_values:
          - playbooks/k8s-deb.yml
        description: "Must be a known Ansible playbook"

resources:
  network:
    type: "OS::Neutron::Net"
    properties:
      name:
        str_replace:
          template: $prefix-k8s-network
          params:
            $prefix:
              get_param: prefix
      port_security_enabled: false
      admin_state_up: true
      availability_zone_hints:
        - get_param: availability_zone

  subnet:
    type: "OS::Neutron::Subnet"
    properties:
      name:
        str_replace:
          template: $prefix-k8s-subnet
          params:
            $prefix:
              get_param: prefix
      network_id:
        get_resource: network
      cidr:
        get_param: network_cidr
      ip_version: 4
      enable_dhcp: true
      allocation_pools:
        - start:
            get_param: allocation_pool_start
          end:
            get_param: allocation_pool_stop

  router:
    type: "OS::Neutron::Router"
    properties:
      name:
        str_replace:
          template: $prefix-k8s-router
          params:
            $prefix:
              get_param: prefix
      admin_state_up: true
      external_gateway_info:
        network:
          get_param: external_network

  router_interface:
    type: "OS::Neutron::RouterInterface"
    properties:
      router_id:
        get_resource: router
      subnet_id:
        get_resource: subnet

  # Control Plane 1
  port_cp_1:
    type: "OS::Neutron::Port"
    properties:
      name:
        str_replace:
          template: $prefix-k8s-port-cp-1
          params:
            $prefix:
              get_param: prefix
      network:
        get_resource: network
      admin_state_up: true
      port_security_enabled: false
      fixed_ips:
        - subnet:
            get_resource: subnet
          ip_address:
            get_param: cp_1_ip

  floating_ip_cp_1:
    type: "OS::Neutron::FloatingIP"
    properties:
      floating_network:
        get_param: external_network
      port_id:
        get_resource: port_cp_1

  cp_1_wait_handle:
    type: "OS::Heat::WaitConditionHandle"

  cp_1_wait_condition:
    type: "OS::Heat::WaitCondition"
    properties:
      handle:
        get_resource: cp_1_wait_handle
      timeout: 3600

  cp_1_user_data:
    type: "OS::Heat::Value"
    properties:
      value:
        str_replace:
          template: |
            #cloud-config

            # https://cloudinit.readthedocs.io/en/24.1/reference/examples.html
            # Logs are in:
            #  - /var/log/cloud-init.log
            #  - /var/log/cloud-init-output.log

            users:
              - name: root
                shell: /bin/bash
                lock_passwd: false
                plain_text_passwd: root
                ssh_authorized_keys: %ssh_keys%

            runcmd:
              - |
                apt-get update && apt-get install -y ansible git || true

                ansible-pull -U "https://github.com/s3rj1k/playground.git" playbooks/base.yml -vvvv
                if [ $? -ne 0 ]; then
                  %wc_notify% --data-binary "{\"status\": \"FAILURE\", \"reason\": \"Ansible base playbook execution failed\"}"
                  exit 1
                fi

                ansible-pull -U "https://github.com/s3rj1k/playground.git" \
                  %ansible_playbook% \
                  -vvvv \
                  -e "REGISTRY_MIRROR='%registry_mirror%' \
                      CP_LB_IP='%cp_lb_ip%'"
                ANSIBLE_RESULT=$?

                if [ $ANSIBLE_RESULT -eq 0 ]; then
                  # Generate CP join command with certificate key
                  CERT_KEY=$(kubeadm init phase upload-certs --upload-certs 2>/dev/null | tail -1)
                  CP_JOIN_DATA=$(kubeadm token create --print-join-command --certificate-key "$CERT_KEY")
                  # Generate worker join command
                  WORKER_DATA=$(kubeadm token create --print-join-command)
                  %wc_notify% --data-binary "{\"status\": \"SUCCESS\", \"data\": {\"cp_join\": \"$CP_JOIN_DATA\", \"worker_join\": \"$WORKER_DATA\"}}"
                else
                  %wc_notify% --data-binary "{\"status\": \"FAILURE\", \"reason\": \"Ansible playbook execution failed\"}"
                  exit 1
                fi
          params:
            "%ssh_keys%":
              get_param: ssh_pub_key
            "%ansible_playbook%":
              get_param: ansible_playbook
            "%registry_mirror%":
              get_param: registry_mirror
            "%cp_lb_ip%":
              get_param: cp_lb_ip
            "%wc_notify%":
              get_attr:
                - cp_1_wait_handle
                - curl_cli

  cp_1:
    type: "OS::Nova::Server"
    properties:
      name:
        str_replace:
          template: "%prefix%-k8s-cp-1"
          params:
            "%prefix%":
              get_param: prefix
      availability_zone:
        get_param: availability_zone
      flavor:
        get_param: cp_flavor
      config_drive: true
      block_device_mapping_v2:
        - image_id:
            get_param: image_id
          delete_on_termination: true
          boot_index: 0
          volume_size:
            get_param: cp_volume_size
      networks:
        - port:
            get_resource: port_cp_1
      user_data_format: RAW
      user_data:
        get_attr:
          - cp_1_user_data
          - value

  # Control Plane 2
  port_cp_2:
    type: "OS::Neutron::Port"
    properties:
      name:
        str_replace:
          template: $prefix-k8s-port-cp-2
          params:
            $prefix:
              get_param: prefix
      network:
        get_resource: network
      admin_state_up: true
      port_security_enabled: false
      fixed_ips:
        - subnet:
            get_resource: subnet
          ip_address:
            get_param: cp_2_ip

  floating_ip_cp_2:
    type: "OS::Neutron::FloatingIP"
    properties:
      floating_network:
        get_param: external_network
      port_id:
        get_resource: port_cp_2

  cp_2_wait_handle:
    type: "OS::Heat::WaitConditionHandle"

  cp_2_wait_condition:
    type: "OS::Heat::WaitCondition"
    properties:
      handle:
        get_resource: cp_2_wait_handle
      timeout: 3600

  cp_2_user_data:
    type: "OS::Heat::Value"
    properties:
      value:
        str_replace:
          template: |
            #cloud-config

            # https://cloudinit.readthedocs.io/en/24.1/reference/examples.html
            # Logs are in:
            #  - /var/log/cloud-init.log
            #  - /var/log/cloud-init-output.log

            users:
              - name: root
                shell: /bin/bash
                lock_passwd: false
                plain_text_passwd: root
                ssh_authorized_keys: %ssh_keys%

            write_files:
              - path: /tmp/join_data.json
                content: '%join_data%'
                permissions: '0600'

            runcmd:
              - |
                apt-get update && apt-get install -y ansible git jq || true

                CP_JOIN_DATA=$(cat /tmp/join_data.json | jq -r '."1".cp_join')
                rm -f /tmp/join_data.json

                ansible-pull -U "https://github.com/s3rj1k/playground.git" playbooks/base.yml -vvvv
                if [ $? -ne 0 ]; then
                  %wc_notify% --data-binary "{\"status\": \"FAILURE\", \"reason\": \"Ansible base playbook execution failed\"}"
                  exit 1
                fi

                ansible-pull -U "https://github.com/s3rj1k/playground.git" \
                  %ansible_playbook% \
                  -vvvv \
                  -e "REGISTRY_MIRROR='%registry_mirror%'" \
                  -e '{"CP_JOIN_DATA": "'"${CP_JOIN_DATA}"'"}'
                ANSIBLE_RESULT=$?

                if [ $ANSIBLE_RESULT -eq 0 ]; then
                  %wc_notify% --data-binary '{"status": "SUCCESS", "data": "CP 2 setup complete"}'
                else
                  %wc_notify% --data-binary '{"status": "FAILURE", "reason": "CP 2 setup failed"}'
                  exit 1
                fi
          params:
            "%ssh_keys%":
              get_param: ssh_pub_key
            "%ansible_playbook%":
              get_param: ansible_playbook
            "%registry_mirror%":
              get_param: registry_mirror
            "%join_data%":
              get_attr:
                - cp_1_wait_condition
                - data
            "%wc_notify%":
              get_attr:
                - cp_2_wait_handle
                - curl_cli

  cp_2:
    type: "OS::Nova::Server"
    depends_on: cp_1_wait_condition
    properties:
      name:
        str_replace:
          template: "%prefix%-k8s-cp-2"
          params:
            "%prefix%":
              get_param: prefix
      availability_zone:
        get_param: availability_zone
      flavor:
        get_param: cp_flavor
      config_drive: true
      block_device_mapping_v2:
        - image_id:
            get_param: image_id
          delete_on_termination: true
          boot_index: 0
          volume_size:
            get_param: cp_volume_size
      networks:
        - port:
            get_resource: port_cp_2
      user_data_format: RAW
      user_data:
        get_attr:
          - cp_2_user_data
          - value

  # Control Plane 3
  port_cp_3:
    type: "OS::Neutron::Port"
    properties:
      name:
        str_replace:
          template: $prefix-k8s-port-cp-3
          params:
            $prefix:
              get_param: prefix
      network:
        get_resource: network
      admin_state_up: true
      port_security_enabled: false
      fixed_ips:
        - subnet:
            get_resource: subnet
          ip_address:
            get_param: cp_3_ip

  floating_ip_cp_3:
    type: "OS::Neutron::FloatingIP"
    properties:
      floating_network:
        get_param: external_network
      port_id:
        get_resource: port_cp_3

  cp_3_wait_handle:
    type: "OS::Heat::WaitConditionHandle"

  cp_3_wait_condition:
    type: "OS::Heat::WaitCondition"
    properties:
      handle:
        get_resource: cp_3_wait_handle
      timeout: 3600

  cp_3_user_data:
    type: "OS::Heat::Value"
    properties:
      value:
        str_replace:
          template: |
            #cloud-config

            # https://cloudinit.readthedocs.io/en/24.1/reference/examples.html
            # Logs are in:
            #  - /var/log/cloud-init.log
            #  - /var/log/cloud-init-output.log

            users:
              - name: root
                shell: /bin/bash
                lock_passwd: false
                plain_text_passwd: root
                ssh_authorized_keys: %ssh_keys%

            write_files:
              - path: /tmp/join_data.json
                content: '%join_data%'
                permissions: '0600'

            runcmd:
              - |
                apt-get update && apt-get install -y ansible git jq || true

                CP_JOIN_DATA=$(cat /tmp/join_data.json | jq -r '."1".cp_join')
                rm -f /tmp/join_data.json

                ansible-pull -U "https://github.com/s3rj1k/playground.git" playbooks/base.yml -vvvv
                if [ $? -ne 0 ]; then
                  %wc_notify% --data-binary "{\"status\": \"FAILURE\", \"reason\": \"Ansible base playbook execution failed\"}"
                  exit 1
                fi

                ansible-pull -U "https://github.com/s3rj1k/playground.git" \
                  %ansible_playbook% \
                  -vvvv \
                  -e "REGISTRY_MIRROR='%registry_mirror%'" \
                  -e '{"CP_JOIN_DATA": "'"${CP_JOIN_DATA}"'"}'
                ANSIBLE_RESULT=$?

                if [ $ANSIBLE_RESULT -eq 0 ]; then
                  %wc_notify% --data-binary '{"status": "SUCCESS", "data": "CP 3 setup complete"}'
                else
                  %wc_notify% --data-binary '{"status": "FAILURE", "reason": "CP 3 setup failed"}'
                  exit 1
                fi
          params:
            "%ssh_keys%":
              get_param: ssh_pub_key
            "%ansible_playbook%":
              get_param: ansible_playbook
            "%registry_mirror%":
              get_param: registry_mirror
            "%join_data%":
              get_attr:
                - cp_1_wait_condition
                - data
            "%wc_notify%":
              get_attr:
                - cp_3_wait_handle
                - curl_cli

  cp_3:
    type: "OS::Nova::Server"
    depends_on: cp_2_wait_condition
    properties:
      name:
        str_replace:
          template: "%prefix%-k8s-cp-3"
          params:
            "%prefix%":
              get_param: prefix
      availability_zone:
        get_param: availability_zone
      flavor:
        get_param: cp_flavor
      config_drive: true
      block_device_mapping_v2:
        - image_id:
            get_param: image_id
          delete_on_termination: true
          boot_index: 0
          volume_size:
            get_param: cp_volume_size
      networks:
        - port:
            get_resource: port_cp_3
      user_data_format: RAW
      user_data:
        get_attr:
          - cp_3_user_data
          - value

  # Worker Node 1
  port_worker_1:
    type: "OS::Neutron::Port"
    properties:
      name:
        str_replace:
          template: $prefix-k8s-port-worker-1
          params:
            $prefix:
              get_param: prefix
      network:
        get_resource: network
      admin_state_up: true
      port_security_enabled: false
      fixed_ips:
        - subnet:
            get_resource: subnet
          ip_address:
            get_param: worker_1_ip

  floating_ip_worker_1:
    type: "OS::Neutron::FloatingIP"
    properties:
      floating_network:
        get_param: external_network
      port_id:
        get_resource: port_worker_1

  worker_1_wait_handle:
    type: "OS::Heat::WaitConditionHandle"

  worker_1_wait_condition:
    type: "OS::Heat::WaitCondition"
    properties:
      handle:
        get_resource: worker_1_wait_handle
      timeout: 3600

  worker_1_user_data:
    type: "OS::Heat::Value"
    properties:
      value:
        str_replace:
          template: |
            #cloud-config

            # https://cloudinit.readthedocs.io/en/24.1/reference/examples.html
            # Logs are in:
            #  - /var/log/cloud-init.log
            #  - /var/log/cloud-init-output.log

            users:
              - name: root
                shell: /bin/bash
                lock_passwd: false
                plain_text_passwd: root
                ssh_authorized_keys: %ssh_keys%

            write_files:
              - path: /tmp/join_data.json
                content: '%join_data%'
                permissions: '0600'

            runcmd:
              - |
                apt-get update && apt-get install -y ansible git jq || true

                WORKER_DATA=$(cat /tmp/join_data.json | jq -r '."1".worker_join')
                rm -f /tmp/join_data.json

                ansible-pull -U "https://github.com/s3rj1k/playground.git" playbooks/base.yml -vvvv
                if [ $? -ne 0 ]; then
                  %wc_notify% --data-binary "{\"status\": \"FAILURE\", \"reason\": \"Ansible base playbook execution failed\"}"
                  exit 1
                fi

                ansible-pull -U "https://github.com/s3rj1k/playground.git" \
                  %ansible_playbook% \
                  -vvvv \
                  -e "REGISTRY_MIRROR='%registry_mirror%'" \
                  -e '{"WORKER_DATA": "'"${WORKER_DATA}"'"}'
                ANSIBLE_RESULT=$?

                if [ $ANSIBLE_RESULT -eq 0 ]; then
                  %wc_notify% --data-binary '{"status": "SUCCESS", "data": "Worker 1 setup complete"}'
                else
                  %wc_notify% --data-binary '{"status": "FAILURE", "reason": "Worker 1 setup failed"}'
                  exit 1
                fi
          params:
            "%ssh_keys%":
              get_param: ssh_pub_key
            "%ansible_playbook%":
              get_param: ansible_playbook
            "%registry_mirror%":
              get_param: registry_mirror
            "%join_data%":
              get_attr:
                - cp_1_wait_condition
                - data
            "%wc_notify%":
              get_attr:
                - worker_1_wait_handle
                - curl_cli

  worker_1:
    type: "OS::Nova::Server"
    depends_on: cp_3_wait_condition
    properties:
      name:
        str_replace:
          template: "%prefix%-k8s-worker-1"
          params:
            "%prefix%":
              get_param: prefix
      availability_zone:
        get_param: availability_zone
      flavor:
        get_param: worker_flavor
      config_drive: true
      block_device_mapping_v2:
        - image_id:
            get_param: image_id
          delete_on_termination: true
          boot_index: 0
          volume_size:
            get_param: worker_volume_size
      networks:
        - port:
            get_resource: port_worker_1
      user_data_format: RAW
      user_data:
        get_attr:
          - worker_1_user_data
          - value

outputs:
  cp_1_floating_ip:
    description: Floating IP address for Control Plane 1
    value:
      get_attr:
        - floating_ip_cp_1
        - floating_ip_address

  cp_2_floating_ip:
    description: Floating IP address for Control Plane 2
    value:
      get_attr:
        - floating_ip_cp_2
        - floating_ip_address

  cp_3_floating_ip:
    description: Floating IP address for Control Plane 3
    value:
      get_attr:
        - floating_ip_cp_3
        - floating_ip_address

  worker_1_floating_ip:
    description: Floating IP address for Worker 1
    value:
      get_attr:
        - floating_ip_worker_1
        - floating_ip_address

  cp_1_user_data:
    description: Rendered CP 1 user-data
    value:
      get_attr:
        - cp_1_user_data
        - value

  cp_2_user_data:
    description: Rendered CP 2 user-data
    value:
      get_attr:
        - cp_2_user_data
        - value

  cp_3_user_data:
    description: Rendered CP 3 user-data
    value:
      get_attr:
        - cp_3_user_data
        - value

  worker_1_user_data:
    description: Rendered Worker 1 user-data
    value:
      get_attr:
        - worker_1_user_data
        - value

  join_data:
    description: Join data from CP 1
    value:
      get_attr:
        - cp_1_wait_condition
        - data
